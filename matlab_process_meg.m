files = { ...
    'sub-A2002/meg/sub-A2002_task-auditory_meg.ds';
'sub-A2003/meg/sub-A2003_task-auditory_meg.ds';
'sub-A2004/meg/sub-A2004_task-auditory_meg.ds';
'sub-A2005/meg/sub-A2005_task-auditory_meg.ds';
'sub-A2006/meg/sub-A2006_task-auditory_meg.ds';
'sub-A2007/meg/sub-A2007_task-auditory_meg.ds';
'sub-A2008/meg/sub-A2008_task-auditory_meg.ds';
'sub-A2009/meg/sub-A2009_task-auditory_meg.ds';
'sub-A2010/meg/sub-A2010_task-auditory_meg.ds';
'sub-A2011/meg/sub-A2011_task-auditory_run-2_meg.ds';
'sub-A2013/meg/sub-A2013_task-auditory_meg.ds';
'sub-A2014/meg/sub-A2014_task-auditory_meg.ds';
'sub-A2015/meg/sub-A2015_task-auditory_meg.ds';
'sub-A2016/meg/sub-A2016_task-auditory_meg.ds';
'sub-A2017/meg/sub-A2017_task-auditory_meg.ds';
'sub-A2019/meg/sub-A2019_task-auditory_meg.ds';
'sub-A2020/meg/sub-A2020_task-auditory_meg.ds';
'sub-A2021/meg/sub-A2021_task-auditory_meg.ds';
'sub-A2024/meg/sub-A2024_task-auditory_meg.ds';
'sub-A2025/meg/sub-A2025_task-auditory_meg.ds';
'sub-A2027/meg/sub-A2027_task-auditory_meg.ds';
'sub-A2028/meg/sub-A2028_task-auditory_meg.ds';
'sub-A2029/meg/sub-A2029_task-auditory_meg.ds';
'sub-A2030/meg/sub-A2030_task-auditory_meg.ds';
'sub-A2031/meg/sub-A2031_task-auditory_meg.ds';
'sub-A2032/meg/sub-A2032_task-auditory_meg.ds';
'sub-A2033/meg/sub-A2033_task-auditory_meg.ds';
'sub-A2034/meg/sub-A2034_task-auditory_meg.ds';
'sub-A2035/meg/sub-A2035_task-auditory_meg.ds';
'sub-A2036/meg/sub-A2036_task-auditory_run-2_meg.ds';
'sub-A2037/meg/sub-A2037_task-auditory_meg.ds';
'sub-A2038/meg/sub-A2038_task-auditory_meg.ds';
'sub-A2039/meg/sub-A2039_task-auditory_meg.ds';
'sub-A2040/meg/sub-A2040_task-auditory_meg.ds';
'sub-A2041/meg/sub-A2041_task-auditory_meg.ds';
'sub-A2042/meg/sub-A2042_task-auditory_meg.ds';
'sub-A2046/meg/sub-A2046_task-auditory_meg.ds';
'sub-A2047/meg/sub-A2047_task-auditory_meg.ds';
'sub-A2049/meg/sub-A2049_task-auditory_meg.ds';
'sub-A2050/meg/sub-A2050_task-auditory_meg.ds';
'sub-A2051/meg/sub-A2051_task-auditory_meg.ds';
'sub-A2052/meg/sub-A2052_task-auditory_meg.ds';
'sub-A2053/meg/sub-A2053_task-auditory_meg.ds';
'sub-A2055/meg/sub-A2055_task-auditory_meg.ds';
'sub-A2056/meg/sub-A2056_task-auditory_meg.ds';
'sub-A2057/meg/sub-A2057_task-auditory_meg.ds';
'sub-A2058/meg/sub-A2058_task-auditory_meg.ds';
'sub-A2059/meg/sub-A2059_task-auditory_meg.ds';
'sub-A2061/meg/sub-A2061_task-auditory_meg.ds';
'sub-A2062/meg/sub-A2062_task-auditory_run-2_meg.ds';
'sub-A2063/meg/sub-A2063_task-auditory_run-2_meg.ds';
'sub-A2064/meg/sub-A2064_task-auditory_meg.ds';
'sub-A2065/meg/sub-A2065_task-auditory_meg.ds';
'sub-A2066/meg/sub-A2066_task-auditory_meg.ds';
'sub-A2067/meg/sub-A2067_task-auditory_meg.ds';
'sub-A2068/meg/sub-A2068_task-auditory_meg.ds';
'sub-A2069/meg/sub-A2069_task-auditory_meg.ds';
'sub-A2070/meg/sub-A2070_task-auditory_meg.ds';
'sub-A2071/meg/sub-A2071_task-auditory_meg.ds';
'sub-A2072/meg/sub-A2072_task-auditory_meg.ds';
'sub-A2073/meg/sub-A2073_task-auditory_meg.ds';
'sub-A2075/meg/sub-A2075_task-auditory_meg.ds';
'sub-A2076/meg/sub-A2076_task-auditory_run-2_meg.ds';
'sub-A2077/meg/sub-A2077_task-auditory_meg.ds';
'sub-A2078/meg/sub-A2078_task-auditory_meg.ds';
'sub-A2079/meg/sub-A2079_task-auditory_meg.ds';
'sub-A2080/meg/sub-A2080_task-auditory_meg.ds';
'sub-A2083/meg/sub-A2083_task-auditory_meg.ds';
'sub-A2084/meg/sub-A2084_task-auditory_run-2_meg.ds';
'sub-A2085/meg/sub-A2085_task-auditory_meg.ds';
'sub-A2086/meg/sub-A2086_task-auditory_meg.ds';
'sub-A2088/meg/sub-A2088_task-auditory_meg.ds';
'sub-A2089/meg/sub-A2089_task-auditory_meg.ds';
'sub-A2090/meg/sub-A2090_task-auditory_meg.ds';
'sub-A2091/meg/sub-A2091_task-auditory_meg.ds';
'sub-A2092/meg/sub-A2092_task-auditory_meg.ds';
'sub-A2094/meg/sub-A2094_task-auditory_meg.ds';
'sub-A2095/meg/sub-A2095_task-auditory_meg.ds';
'sub-A2096/meg/sub-A2096_task-auditory_meg.ds';
'sub-A2097/meg/sub-A2097_task-auditory_meg.ds';
'sub-A2098/meg/sub-A2098_task-auditory_meg.ds';
'sub-A2099/meg/sub-A2099_task-auditory_meg.ds';
'sub-A2101/meg/sub-A2101_task-auditory_meg.ds'; 
'sub-A2102/meg/sub-A2102_task-auditory_meg.ds'; 
'sub-A2103/meg/sub-A2103_task-auditory_meg.ds';
'sub-A2104/meg/sub-A2104_task-auditory_meg.ds'; 
'sub-A2105/meg/sub-A2105_task-auditory_meg.ds'; 
'sub-A2106/meg/sub-A2106_task-auditory_meg.ds'; 
'sub-A2108/meg/sub-A2108_task-auditory_meg.ds'; 
'sub-A2109/meg/sub-A2109_task-auditory_meg.ds';
'sub-A2110/meg/sub-A2110_task-auditory_meg.ds'; 
'sub-A2111/meg/sub-A2111_task-auditory_meg.ds'; 
'sub-A2113/meg/sub-A2113_task-auditory_meg.ds'; 
'sub-A2114/meg/sub-A2114_task-auditory_meg.ds'; 
'sub-A2116/meg/sub-A2116_task-auditory_meg.ds'; 
'sub-A2117/meg/sub-A2117_task-auditory_meg.ds'; 
'sub-A2119/meg/sub-A2119_task-auditory_meg.ds'; 
'sub-A2120/meg/sub-A2120_task-auditory_meg.ds'; 
'sub-A2121/meg/sub-A2121_task-auditory_meg.ds'; 
'sub-A2122/meg/sub-A2122_task-auditory_meg.ds'; 
'sub-A2124/meg/sub-A2124_task-auditory_meg.ds'; 
'sub-A2125/meg/sub-A2125_task-auditory_meg.ds' }; % last file cannot find type automatically, add ", 'headerformat', 'ctf_ds');" to line 146 of pop_fileio


if ~exist('eeglab')
    addpath('~/data/matlab/eeglab'); eeglab
end

filePath = '/Users/arno/Downloads/Donders/';
for iFile = 1:length(files)
    try
        subject    = files{iFile}(1:9);
        fileMat    = fullfile(filePath, [ subject '.mat' ]);
        if ~exist(fileMat, "file")
            subjectnum = str2num( files{iFile}(7:9) );
            EEG = pop_fileio( fullfile(filePath, files{iFile}), 'dataformat','auto');
            EEG = pop_select(EEG, 'chantype', 'meggrad');
            EEG = eeg_epoch2continuous(EEG);
            EEG = pop_epoch(EEG, 'wav', [0 3]);
        
            audioFile = cell(1, EEG.trials);
            for iEvent = 1:length(EEG.event)
                if contains(EEG.event(iEvent).type, '.wav')
                    audioFile{ EEG.event(iEvent).epoch } = strip(EEG.event(iEvent).type(14:end));
                end
            end
            if any(cellfun(@isempty, audioFile))
                error('Some epochs do not contain data')
            end
            data = [];
            data.data = EEG.data;
            data.audiofiles = audioFile;
            data.subject    = subject;
            data.subjectnum = subjectnum;
            save('-mat', fileMat, '-struct', 'data');
        end
        fprintf(2, '%d OK \n', iFile)
    catch
        fprintf(2, '\nFile error %s\n\n', files{iFile})
    end
end